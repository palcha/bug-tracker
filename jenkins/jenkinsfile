pipeline {
    agent any

    stages {   
        stage('Unit test - backend') {
            agent{
                docker{
                    image 'snakee/golang-junit:1.21'
                    reuseNode true
                }
            }
            steps {
               dir('bugtracker-backend'){
                sh 'GOCACHE=/tmp/go-build GOMODCACHE=/tmp/go-mod go test ./...'
               }
            }
        }
        stage('Unit test - frontend') {
            agent{
                docker{
                    image 'node:20-alpine'
                    reuseNode true
                }
            }
            steps {
               dir('bugtracker-frontend'){
                sh '''
                   npm ci
                   npm test
                '''
                
               }
            }
        }
        stage('lunch application'){
            agent {
                docker{
                    image 'docker:27.5.1'
                    reuseNode true
                    args '-v /var/run/docker.sock:/var/run/docker.sock -u 0'
                }
            }
            steps {
                sh 'docker compose up --build -d'
            }
        }
        stage('API Test'){
            agent {
                docker{
                    image 'mcr.microsoft.com/playwright:v1.50.0-jammy'
                    reuseNode true
                    args '-u 0 --network=host'
                }
            }
                steps {
                    dir('tests-api'){
                        sh 'npx wait-port http://localhost:8080/api/health -t 30000'
                        sh 'npm ci'
                        sh 'npx playwright test'
                    }
                }
            post {
        always{
            junit 'tests-api/test-results/results.xml'
            publishHTML target: [
                      reportDir: 'tests-api/playwright-report',
                      reportFiles: 'index.html',
                      reportName: 'Playwright API test report'
            ]
        }
    }
        }
      stage('E2E test'){
        agent{
            docker{
              image 'mcr.microsoft.com/playwright:v1.50.0-jammy'
                    reuseNode true
                    args '-u 0 --network=host'  
            }
        }
        steps{
            dir('tests-e2e'){
                sh 'npm ci'
                sh 'npx playwright test'
            }
        }
        post{
            always{
              junit 'tests-e2e/test-results/results.xml'  
              publishHTML target: [
                      reportDir: 'tests-e2e/playwright-report',
                      reportFiles: 'index.html',
                      reportName: 'Playwright API test report'
            ]
            }
        }
      }   
        
    }
    
    post{
        always{
            cleanWs()
        }
    }
}